{{- $image := printf "%s/%s:%s" .Values.server.image.registry .Values.server.image.repository .Values.server.image.tag -}}
apiVersion: apps/v1
kind: StatefulSet
metadata:
  creationTimestamp: null
  labels:
    app: chart-paper-server
  name: chart-paper-server
spec:
  replicas: {{.Values.server.replicas}}
  selector:
    matchLabels:
      app: chart-paper-server
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: chart-paper-server
    spec:
      containers:
      - image: {{$image}} 
        name: chartpaper-chart-paper-server
        env:
          - name: "DATABASE_URL"
            valueFrom:
              secretKeyRef:
                name: {{.Values.server.db.secret}}
                key: {{.Values.server.db.key}}
        resources: {}
        {{- if .Values.server.probes.enabled}}
        livenessProbe:
          httpGet:
            path: /livez
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /healthz
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 30
        {{- end}}
        lifecycle:
          postStart:
            exec:
              command:
                - /app/server
                - migrate
